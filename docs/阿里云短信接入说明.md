# 阿里云短信验证码接入说明

按下面步骤配置后，注册/登录时将通过阿里云真实发送短信验证码。

---

## 一、你需要在阿里云完成的配置

### 1. 获取 AccessKey（用于 API 调用）

1. 登录 [阿里云控制台](https://www.aliyun.com/)
2. 右上角头像 → **AccessKey 管理**（或搜索「访问控制 RAM」）
3. 建议使用 **RAM 子用户**（不要用主账号 Key）：
   - 进入 **访问控制 RAM** → **用户** → **创建用户**
   - 登录名称自定，勾选 **OpenAPI 调用**
   - 创建后为该用户添加权限：**AliyunDysmsFullAccess**（短信服务完全访问）
   - 在用户详情里 **创建 AccessKey**，保存 **AccessKey ID** 和 **AccessKey Secret**（只显示一次）

### 2. 申请短信签名

1. 打开 [短信服务控制台](https://dysms.console.aliyun.com/)
2. **国内消息** → **签名管理** → **添加签名**
3. 填写签名名称（如「交易纪律官」）、适用场景（如「验证码」）、证明等，提交审核
4. 审核通过后，记下 **签名名称**（如 `交易纪律官`），用于环境变量 `SMS_SIGN_NAME`

### 3. 申请短信模板

1. **国内消息** → **模板管理** → **添加模板**
2. 模板类型选 **验证码**
3. 模板内容中必须包含一个变量，变量名设为 **code**，例如：
   - `您的验证码为：${code}，5分钟内有效。`
4. 提交审核，通过后记下 **模板 CODE**（如 `SMS_123456789`），用于环境变量 `SMS_TEMPLATE_CODE`

> 重要：本后端默认使用变量名 **code**。若你在阿里云申请的模板里变量名是别的（如 `verification_code`），在 `.env` 中增加一行：`SMS_TEMPLATE_PARAM_NAME=verification_code`。

---

## 二、在后端配置环境变量

### 方式 A：本地开发（使用 .env 文件）

1. 在 `backend` 目录下复制示例配置：
   ```bash
   cp .env.example .env
   ```
2. 用编辑器打开 `.env`，填入你在阿里云得到的值：
   ```env
   SMS_MOCK_MODE=false
   SMS_ACCESS_KEY_ID=LTAI5txxxxxxxxxx
   SMS_ACCESS_KEY_SECRET=xxxxxxxxxxxxxxxx
   SMS_SIGN_NAME=交易纪律官
   SMS_TEMPLATE_CODE=SMS_123456789
   ```
3. 安装依赖（若尚未安装）：
   ```bash
   npm install
   ```
4. 重启后端：
   ```bash
   npm run dev
   ```

### 方式 B：部署到 Render / 其他云

在对应平台的环境变量（Environment Variables）里添加上述 5 个变量，不要提交 `.env` 到 Git。

---

## 三、验证是否生效

1. 关闭模拟模式后，后端会向阿里云发起真实请求。
2. 在 App 注册页输入手机号，点击「获取验证码」。
3. 若配置正确，手机会收到短信，用该验证码完成注册即可。
4. 若失败，查看后端控制台日志：
   - `短信服务未配置` → 检查 `SMS_ACCESS_KEY_ID`、`SMS_ACCESS_KEY_SECRET` 是否填写
   - `SignatureDoesNotMatch` → 检查 AccessKey 是否正确、是否有短信权限
   - `InvalidSignName` → 签名未审核通过或 `SMS_SIGN_NAME` 与控制台不一致
   - `InvalidTemplateCode` → 模板未审核通过或 `SMS_TEMPLATE_CODE` 填错

---

## 四、暂时不接阿里云时（测试用）

不设置 `SMS_MOCK_MODE` 或设为 `true` 时，为 **模拟模式**：不会发真实短信，验证码固定为 **123456**，可直接用 123456 完成注册/验证。
